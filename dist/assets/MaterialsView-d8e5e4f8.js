import{_ as R,r as m,f as U,g as N,h as H,n as K,o as r,c as d,b as e,k as c,l as u,d as _,v as k,t as i,F as Q,i as W,w as X,m as w,e as h}from"./index-0c1afda6.js";import{u as Y}from"./material.store-3b57c0b7.js";import{u as Z}from"./productos.store-faf1803a.js";import{T as ee}from"./bootstrap.esm-5571e70d.js";import"./sale.store-8ef729cf.js";const te={class:"container py-4"},se={class:"d-flex justify-content-between align-items-center mb-3"},oe=["disabled"],le={class:"mb-3"},ae=["disabled"],ne={key:0,class:"text-center my-4"},ie={key:1,class:"alert alert-danger"},re={key:2,class:"alert alert-info"},de={key:3,class:"table-responsive"},ce={class:"table table-bordered table-hover mb-0"},ue={class:"d-flex align-items-center"},me=["onClick","disabled"],fe=["onClick","disabled"],be=["onClick","disabled"],ve=["data-bs-title"],pe={class:"text-end"},ge={class:"d-flex justify-content-between align-items-center"},ye={class:"row g-2 mb-3"},_e={class:"col-md-6"},ke=["readonly"],we={class:"invalid-feedback"},he={class:"col-md-6"},Ce=["readonly"],xe={class:"invalid-feedback"},Me={class:"row g-2 mb-3"},Ee={class:"col-md-6"},Se=["readonly"],Ve={class:"invalid-feedback"},De={class:"col-md-6"},Ne=["readonly"],Te={class:"invalid-feedback"},qe={class:"d-flex justify-content-end mt-3"},$e=["disabled"],Be=["disabled"],Oe={key:0,class:"spinner-border spinner-border-sm me-1",role:"status","aria-hidden":"true"},Ue={key:0,class:"text-danger"},je={class:"d-flex justify-content-end mt-3"},Ae=["disabled"],Fe=["disabled"],Ie={key:0,class:"spinner-border spinner-border-sm me-1",role:"status","aria-hidden":"true"},T=10,Le={__name:"MaterialsView",props:{isAdmin:{type:Boolean,default:!1}},setup(Pe){const n=Y(),q=Z(),M=m(""),E=m(null),S=m(null),C=m("new"),v=m(!1),p=m(!1),b=m(null),x=m(!1),o=U({id:null,cod:"",name:"",unit_cost:0,stock:0}),a=U({cod:"",name:"",unit_cost:"",stock:""}),j=N(()=>{const s=M.value.toLowerCase();return n.materiales.filter(t=>t.name.toLowerCase().includes(s)||t.cod.toLowerCase().includes(s)).sort((t,f)=>t.name.localeCompare(f.name))}),A=N(()=>{switch(C.value){case"new":return"Nuevo Material";case"edit":return"Editar Material";case"view":return"Ver Material";default:return"Material"}}),g=N(()=>C.value==="view");function F(s){return new Intl.NumberFormat("es-BO",{style:"currency",currency:"BOB"}).format(s)}function I(){let s=!0;return a.cod="",a.name="",a.unit_cost="",a.stock="",o.cod.trim()||(a.cod="El código es requerido",s=!1),o.name.trim()||(a.name="El nombre es requerido",s=!1),o.unit_cost<=0&&(a.unit_cost="El costo debe ser mayor a 0",s=!1),o.stock<0&&(a.stock="El stock no puede ser negativo",s=!1),s}function V(s,t=null){if(C.value=s,t)Object.assign(o,JSON.parse(JSON.stringify(t)));else if($(),n.materiales.length>0){const y=n.materiales[n.materiales.length-1].cod.match(/(\d+)$/);if(y){const l=parseInt(y[1])+1;o.cod=`MAT-${l.toString().padStart(3,"0")}`}}else o.cod="MAT-001";E.value.showModal()}function D(){E.value.close(),$()}function $(){o.id=null,o.cod="",o.name="",o.unit_cost=0,o.stock=0,L()}function L(){a.cod="",a.name="",a.unit_cost="",a.stock=""}async function P(){if(I()){v.value=!0;try{C.value==="new"?await n.addMaterial({...o}):await n.updateMaterial(o.id,{...o}),D()}catch(s){console.error("Error al guardar material:",s),s.response&&s.response.data?alert(`Error: ${s.response.data.message}`):alert("Ocurrió un error al guardar el material")}finally{v.value=!1}}}function z(s){b.value=s,x.value=J(s.cod),S.value.showModal()}function B(){S.value.close(),b.value=null,x.value=!1}function J(s){return q.productos.some(t=>t.bom.some(f=>f.cod===s))}async function G(){if(b.value){p.value=!0;try{await n.deleteMaterial(b.value.id),B()}catch(s){console.error("Error al eliminar material:",s),alert("Ocurrió un error al eliminar el material")}finally{p.value=!1}}}return H(async()=>{try{await Promise.all([n.fetchMateriales(),q.fetchProductos()]),K(()=>{document.querySelectorAll('[data-bs-toggle="tooltip"]').forEach(s=>{new ee(s)})})}catch(s){console.error("Error al cargar datos:",s)}}),(s,t)=>{var f,y;return r(),d("div",te,[e("div",se,[t[8]||(t[8]=e("h2",null,"Materias Primas",-1)),e("button",{class:"btn btn-success",onClick:t[0]||(t[0]=l=>V("new")),disabled:c(n).loading},t[7]||(t[7]=[e("i",{class:"fa-solid fa-plus"},null,-1),u(" Nuevo Material ")]),8,oe)]),e("div",le,[_(e("input",{"onUpdate:modelValue":t[1]||(t[1]=l=>M.value=l),type:"text",class:"form-control",placeholder:"Filtrar por nombre o código...",disabled:c(n).loading},null,8,ae),[[k,M.value]])]),c(n).loading&&!c(n).materiales.length?(r(),d("div",ne,t[9]||(t[9]=[e("div",{class:"spinner-border text-primary",role:"status"},[e("span",{class:"visually-hidden"},"Cargando...")],-1),e("p",{class:"mt-2"},"Cargando materiales...",-1)]))):c(n).error?(r(),d("div",ie,[t[10]||(t[10]=e("i",{class:"fa-solid fa-triangle-exclamation me-2"},null,-1)),u(" Error al cargar materiales: "+i(c(n).error)+" ",1),e("button",{class:"btn btn-sm btn-outline-danger ms-2",onClick:t[2]||(t[2]=l=>c(n).fetchMateriales())}," Reintentar ")])):c(n).materiales.length?(r(),d("div",de,[e("table",ce,[t[16]||(t[16]=e("thead",{class:"table-light"},[e("tr",null,[e("th",{width:"120"},"Acciones"),e("th",{width:"100"},"Código"),e("th",null,"Nombre"),e("th",{width:"120"},"Costo"),e("th",{width:"120"},"Stock")])],-1)),e("tbody",null,[(r(!0),d(Q,null,W(j.value,l=>(r(),d("tr",{key:l.id},[e("td",null,[e("div",ue,[e("button",{class:"btn btn-sm btn-outline-primary me-1",onClick:O=>V("view",l),disabled:c(n).loading},t[12]||(t[12]=[e("i",{class:"fa-solid fa-eye"},null,-1)]),8,me),e("button",{class:"btn btn-sm btn-outline-success me-1",onClick:O=>V("edit",l),disabled:c(n).loading},t[13]||(t[13]=[e("i",{class:"fa-solid fa-pen-to-square"},null,-1)]),8,fe),e("button",{class:"btn btn-sm btn-outline-secondary",onClick:O=>z(l),disabled:c(n).loading},t[14]||(t[14]=[e("i",{class:"fa-solid fa-trash"},null,-1)]),8,be),l.stock<T?(r(),d("span",{key:0,class:"blinking-icon ms-2","data-bs-toggle":"tooltip","data-bs-placement":"top","data-bs-title":`Stock bajo! Mínimo requerido: ${T}`},t[15]||(t[15]=[e("i",{class:"fa-solid fa-triangle-exclamation text-danger"},null,-1)]),8,ve)):h("",!0)])]),e("td",null,i(l.cod),1),e("td",null,i(l.name),1),e("td",pe,i(F(l.unit_cost)),1),e("td",{class:w(["text-end",{"text-danger":l.stock<T}])},i(l.stock),3)]))),128))])])])):(r(),d("div",re,t[11]||(t[11]=[e("i",{class:"fa-solid fa-circle-info me-2"},null,-1),u(" No se encontraron materiales registrados. ")]))),e("dialog",{ref_key:"materialDialog",ref:E,class:"p-0 border-0"},[e("form",{onSubmit:X(P,["prevent"]),class:"p-3"},[e("h5",ge,[e("span",null,i(A.value),1),e("button",{type:"button",class:"btn-close",onClick:D,"aria-label":"Close"})]),e("div",ye,[e("div",_e,[t[17]||(t[17]=e("label",{class:"form-label"},"Código",-1)),_(e("input",{"onUpdate:modelValue":t[3]||(t[3]=l=>o.cod=l),type:"text",class:w(["form-control",{"is-invalid":a.cod}]),readonly:g.value,required:""},null,10,ke),[[k,o.cod]]),e("div",we,i(a.cod),1)]),e("div",he,[t[18]||(t[18]=e("label",{class:"form-label"},"Nombre",-1)),_(e("input",{"onUpdate:modelValue":t[4]||(t[4]=l=>o.name=l),type:"text",class:w(["form-control",{"is-invalid":a.name}]),readonly:g.value,required:""},null,10,Ce),[[k,o.name]]),e("div",xe,i(a.name),1)])]),e("div",Me,[e("div",Ee,[t[19]||(t[19]=e("label",{class:"form-label"},"Costo unitario (Bs)",-1)),_(e("input",{"onUpdate:modelValue":t[5]||(t[5]=l=>o.unit_cost=l),type:"number",step:"0.01",min:"0",class:w(["form-control",{"is-invalid":a.unit_cost}]),readonly:g.value,required:""},null,10,Se),[[k,o.unit_cost,void 0,{number:!0}]]),e("div",Ve,i(a.unit_cost),1)]),e("div",De,[t[20]||(t[20]=e("label",{class:"form-label"},"Stock",-1)),_(e("input",{"onUpdate:modelValue":t[6]||(t[6]=l=>o.stock=l),type:"number",step:"1",min:"0",class:w(["form-control",{"is-invalid":a.stock}]),readonly:g.value,required:""},null,10,Ne),[[k,o.stock,void 0,{number:!0}]]),e("div",Te,i(a.stock),1)])]),e("div",qe,[e("button",{type:"button",class:"btn btn-secondary me-2",onClick:D,disabled:v.value}," Cancelar ",8,$e),g.value?h("",!0):(r(),d("button",{key:0,type:"submit",class:"btn btn-outline-primary",disabled:v.value},[v.value?(r(),d("span",Oe)):h("",!0),u(" "+i(o.id?"Actualizar":"Guardar"),1)],8,Be))])],32)],512),e("dialog",{ref_key:"confirmDialog",ref:S,class:"p-3 border-0"},[t[24]||(t[24]=e("h5",{class:"mb-3"},[e("i",{class:"fa-solid fa-triangle-exclamation text-warning me-2"}),u("Confirmar eliminación")],-1)),e("p",null,[t[21]||(t[21]=u("¿Está seguro de eliminar el material ")),e("strong",null,i((f=b.value)==null?void 0:f.name),1),u(" ("+i((y=b.value)==null?void 0:y.cod)+")?",1)]),x.value?(r(),d("p",Ue,t[22]||(t[22]=[e("i",{class:"fa-solid fa-circle-exclamation me-2"},null,-1),u(" Este material está siendo utilizado en productos y no puede ser eliminado. ")]))):h("",!0),e("div",je,[e("button",{type:"button",class:"btn btn-secondary me-2",onClick:B,disabled:p.value}," Cancelar ",8,Ae),e("button",{type:"button",class:"btn btn-outline-secondary",onClick:G,disabled:p.value||x.value},[p.value?(r(),d("span",Ie)):h("",!0),t[23]||(t[23]=u(" Eliminar "))],8,Fe)])],512)])}}},Ke=R(Le,[["__scopeId","data-v-885f15f4"]]);export{Ke as default};
