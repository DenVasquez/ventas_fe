import{_ as pt,r as v,f as J,g as w,h as vt,o as a,c as i,b as t,k as p,l as f,d as E,v as A,t as n,F as k,i as C,w as yt,j as W,m as q,e as y}from"./index-0c1afda6.js";import{a as gt,u as _t}from"./sale.store-8ef729cf.js";import{u as ht}from"./productos.store-faf1803a.js";import{h as wt}from"./html2pdf-58b8d0da.js";const kt={class:"container py-4"},Ct={class:"d-flex justify-content-between align-items-center mb-3"},St=["disabled"],xt={class:"mb-3"},Dt=["disabled"],It={key:0,class:"text-center my-4"},Et={key:1,class:"alert alert-danger"},qt={key:2,class:"alert alert-info"},Pt={key:3,class:"table-responsive"},$t={class:"table table-bordered table-hover mb-0"},Tt={class:"d-flex"},Vt=["onClick","disabled"],Ft=["onClick","disabled"],Nt=["onClick","disabled"],Bt=["onClick","disabled"],jt={class:"mb-0 ps-3 small"},At={class:"text-end"},Ot={class:"d-flex justify-content-between align-items-center"},Mt={class:"row g-2 mb-3"},Ut={class:"col-md-6"},Lt=["disabled"],Rt=["value"],zt={class:"invalid-feedback"},Qt={class:"col-md-6"},Jt=["readonly"],Wt={class:"invalid-feedback"},Yt={class:"mb-3"},Ht=["onUpdate:modelValue","disabled","onChange"],Gt=["value","disabled"],Kt=["onUpdate:modelValue","max","readonly"],Xt={class:"me-2"},Zt=["onClick"],te={class:"invalid-feedback"},ee={key:1,class:"invalid-feedback d-block"},se={class:"mb-3 p-2 bg-light rounded"},oe={class:"d-flex justify-content-between fw-bold fs-5"},ne={class:"d-flex justify-content-end mt-3"},le=["disabled"],ae=["disabled"],ie={key:0,class:"spinner-border spinner-border-sm me-1",role:"status","aria-hidden":"true"},re={class:"d-flex justify-content-end mt-3"},de=["disabled"],ce=["disabled"],ue={key:0,class:"spinner-border spinner-border-sm me-1",role:"status","aria-hidden":"true"},me={class:"p-3"},be={key:0,class:"invoice-container border p-3",id:"invoice-container"},fe={class:"row mb-4"},pe={class:"col-md-6"},ve={class:"mb-1"},ye={class:"mb-1 small"},ge={class:"mb-1 small"},_e={class:"mb-1 small"},he={class:"col-md-6 text-end"},we={class:"mb-1"},ke={class:"mb-1"},Ce={class:"mb-1"},Se={class:"row mb-4 border-top border-bottom py-2"},xe={class:"col-md-6"},De={class:"mb-1"},Ie={class:"mb-1 small"},Ee={class:"col-md-6"},qe={class:"mb-1 small"},Pe={class:"table table-bordered mb-4"},$e={class:"text-end"},Te={class:"text-end"},Ve={class:"text-end"},Fe={class:"row border-top pt-3"},Ne={class:"col-md-8"},Be={class:"small"},je={class:"small"},Ae={class:"col-md-4 text-center"},Oe=["src"],Me={class:"small mt-1"},Ue={__name:"SalesView",props:{isAdmin:{type:Boolean,default:!1}},setup(Le){const m=gt(),$=_t(),g=ht(),T=v(""),V=v(null),F=v(null),P=v("new"),S=v(!1),x=v(!1),D=v(null),N=v(null),d=v(null),l=J({id:null,buyer_id:"",items:[],date:new Date().toISOString().slice(0,10),total:0,status:"pending"}),u=J({}),Y=w(()=>$.activeBuyers),H=w(()=>g.productos.filter(s=>s.stock>0)),G=w(()=>{const s=T.value.toLowerCase();return m.sales.filter(e=>L(e.buyer_id).toLowerCase().includes(s)||e.date.includes(s)||e.id.toString().includes(s)).sort((e,c)=>new Date(c.date)-new Date(e.date))}),h=w(()=>P.value==="view"),K=w(()=>P.value==="new"?"Registrar Nueva Venta":P.value==="edit"?"Editar Venta":"Detalle de Venta"),X=w(()=>l.items.reduce((s,e)=>s+e.unit_price*e.qty,0)),O=w(()=>X.value);function M(){Object.keys(u).forEach(s=>delete u[s])}function Z(){M();let s=!0;return l.buyer_id||(u.buyer_id="Seleccione un comprador",s=!1),l.date||(u.date="Seleccione una fecha",s=!1),l.items.length===0&&(u.items="Debe agregar al menos un producto",s=!1),l.items.forEach((e,c)=>{if(e.cod||(u[`items-${c}-cod`]="Seleccione un producto",s=!1),!e.qty||e.qty<=0)u[`items-${c}-qty`]="Cantidad inválida",s=!1;else{const o=g.productos.find(r=>r.cod===e.cod);o&&o.stock<e.qty&&(u[`items-${c}-qty`]=`Stock insuficiente (${o.stock} disponibles)`,s=!1)}}),s}function B(s,e=null){P.value=s,e?Object.assign(l,JSON.parse(JSON.stringify(e))):(tt(),U()),V.value.showModal()}function j(){V.value.close()}function tt(){l.id=null,l.buyer_id="",l.items=[],l.date=new Date().toISOString().slice(0,10),l.total=0,l.status="pending",M()}function U(){l.items.push({cod:"",qty:1,unit_price:0})}function et(s){l.items.splice(s,1)}function st(s){const e=g.productos.find(c=>c.cod===l.items[s].cod);e&&(l.items[s].unit_price=e.unit_cost)}function ot(s){const e=g.productos.find(c=>c.cod===s);return e?e.stock:0}function L(s){const e=$.getBuyerById(s);return e?`${e.name} (${e.company||"Sin empresa"})`:"Comprador no encontrado"}function R(s){const e=g.getProductoById(s);return e?e.name:"Producto no encontrado"}function _(s){return new Intl.NumberFormat("es-BO",{style:"currency",currency:"BOB"}).format(s)}function nt(s){const e=new Date(s);if(isNaN(e.getTime()))return"Fecha inválida";const c=e.getTimezoneOffset()+240,o=new Date(e.getTime()+c*6e4),r=o.getDate(),b=o.toLocaleString("es",{month:"long"}),I=o.getFullYear();return`${r} ${b} ${I}`}function lt(s){return{completed:"bg-success",pending:"bg-warning text-dark",canceled:"bg-danger"}[s]||"bg-secondary"}function at(s){return{completed:"Completado",pending:"Pendiente",canceled:"Cancelado"}[s]||s}function it(s){D.value=s,F.value.showModal()}function z(){F.value.close(),D.value=null}async function rt(){if(D.value){x.value=!0;try{await m.cancelSale(D.value.id),z()}catch(s){console.error("Error al cancelar venta:",s),alert("Ocurrió un error al cancelar la venta")}finally{x.value=!1}}}async function dt(){if(Z()&&confirm("¿Confirmar la venta?")){S.value=!0;try{if(l.total=O.value,l.status="completed",l.id)await m.updateSale(l.id,{...l});else{await m.addSale({...l});for(const s of l.items){const e=g.productos.find(c=>c.cod===s.cod);e&&await g.updateProducto(e.id,{stock:e.stock-s.qty})}}j()}catch(s){console.error("Error al guardar venta:",s),alert("Ocurrió un error al guardar la venta")}finally{S.value=!1}}}async function Q(){try{await Promise.all([m.fetchSales(),$.fetchBuyers(),g.fetchProductos()])}catch(s){console.error("Error al cargar datos:",s)}}const ct=async s=>{try{d.value=await m.generateInvoice(s.id),N.value.showModal()}catch(e){console.error("Error al generar factura:",e),alert("Ocurrió un error al generar la factura")}},ut=()=>{N.value.close()},mt=async()=>{const s=document.getElementById("invoice-container");s.querySelectorAll("button").forEach(I=>I.style.display="none");const e=window.open("","_blank"),o=["https://tudominio.com/styles/main.css","https://cdn.example.com/bootstrap.min.css"].map(I=>fetch(I).then(ft=>ft.text()).catch(()=>"")),b=(await Promise.all(o)).join(`
`);e.document.write(`
    <!DOCTYPE html>
    <html>
      <head>
        <title>Factura</title>
        <style>
          ${b}
          body { margin: 0; padding: 20px; }
          @page { margin: 0; size: auto; }
        </style>
      </head>
      <body>
        ${s.innerHTML}
      </body>
    </html>
  `),e.document.close(),e.onload=()=>{setTimeout(()=>{e.print()},1e3)}},bt=async()=>{try{const s=document.getElementById("invoice-container");if(!s)throw new Error('No se encontró el contenedor con id "invoice-container"');s.querySelectorAll("button").forEach(o=>o.style.display="none");const e=s.clientWidth,c={margin:[10,10,10,10],filename:`FACTURA_${d.value.invoiceNumber}.pdf`,image:{type:"jpeg",quality:.98},html2canvas:{scale:2,width:e,logging:!0,dpi:192,letterRendering:!0},jsPDF:{unit:"mm",format:"a4",orientation:"portrait"},pagebreak:{mode:["css","avoid-all"]}};await wt().set(c).from(s).save()}catch(s){console.error("Error al generar PDF:",s),alert("Error al generar el PDF: "+s.message)}};return vt(()=>{Q()}),(s,e)=>{var c;return a(),i("div",kt,[t("div",Ct,[e[5]||(e[5]=t("h2",null,"Ventas Realizadas",-1)),t("button",{class:"btn btn-success",onClick:e[0]||(e[0]=o=>B("new")),disabled:p(m).loading},e[4]||(e[4]=[t("i",{class:"fa-solid fa-plus me-1"},null,-1),f(" Nueva Venta ")]),8,St)]),t("div",xt,[E(t("input",{"onUpdate:modelValue":e[1]||(e[1]=o=>T.value=o),type:"text",class:"form-control",placeholder:"Filtrar por comprador o fecha...",disabled:p(m).loading},null,8,Dt),[[A,T.value]])]),p(m).loading&&!p(m).sales.length?(a(),i("div",It,e[6]||(e[6]=[t("div",{class:"spinner-border text-primary",role:"status"},[t("span",{class:"visually-hidden"},"Cargando...")],-1),t("p",{class:"mt-2"},"Cargando ventas...",-1)]))):p(m).error?(a(),i("div",Et,[e[7]||(e[7]=t("i",{class:"fa-solid fa-triangle-exclamation me-2"},null,-1)),f(" Error al cargar ventas: "+n(p(m).error)+" ",1),t("button",{class:"btn btn-sm btn-outline-danger ms-2",onClick:Q}," Reintentar ")])):p(m).sales.length?(a(),i("div",Pt,[t("table",$t,[e[14]||(e[14]=t("thead",{class:"table-light"},[t("tr",null,[t("th",{width:"120"},"Acciones"),t("th",{width:"80"},"ID"),t("th",null,"Comprador"),t("th",{width:"120"},"Fecha"),t("th",null,"Productos"),t("th",{width:"120"},"Total"),t("th",{width:"120"},"Estado")])],-1)),t("tbody",null,[(a(!0),i(k,null,C(G.value,o=>(a(),i("tr",{key:o.id},[t("td",null,[t("div",Tt,[t("button",{class:"btn btn-sm btn-outline-primary me-1",onClick:r=>B("view",o),disabled:p(m).loading},e[9]||(e[9]=[t("i",{class:"fa-solid fa-eye"},null,-1)]),8,Vt),o.status!=="canceled"?(a(),i("button",{key:0,class:"btn btn-sm btn-outline-success me-1",onClick:r=>B("edit",o),disabled:p(m).loading},e[10]||(e[10]=[t("i",{class:"fa-solid fa-pen-to-square"},null,-1)]),8,Ft)):y("",!0),o.status!=="canceled"?(a(),i("button",{key:1,class:"btn btn-sm btn-outline-secondary me-1",onClick:r=>it(o),disabled:p(m).loading},e[11]||(e[11]=[t("i",{class:"fa-solid fa-trash"},null,-1)]),8,Nt)):y("",!0),e[13]||(e[13]=t("br",null,null,-1)),t("button",{class:"btn btn-sm btn-outline-info me-1",onClick:r=>ct(o),disabled:o.status==="canceled"||p(m).loading},e[12]||(e[12]=[t("i",{class:"fa-solid fa-file-invoice"},null,-1)]),8,Bt)])]),t("td",null,n(o.id),1),t("td",null,n(L(o.buyer_id)),1),t("td",null,n(nt(o.date)),1),t("td",null,[t("ul",jt,[(a(!0),i(k,null,C(o.items,r=>(a(),i("li",{key:r.cod},n(R(r.cod))+" x"+n(r.qty)+" ("+n(_(r.unit_price))+") ",1))),128))])]),t("td",At,n(_(o.total)),1),t("td",null,[t("span",{class:q(["badge",lt(o.status)])},n(at(o.status)),3)])]))),128))])])])):(a(),i("div",qt,e[8]||(e[8]=[t("i",{class:"fa-solid fa-circle-info me-2"},null,-1),f(" No se encontraron ventas registradas. ")]))),t("dialog",{ref_key:"salesDialog",ref:V,class:"p-0 border-0",style:{"max-width":"800px"}},[t("form",{onSubmit:yt(dt,["prevent"]),class:"p-3"},[t("h5",Ot,[t("span",null,n(K.value),1),t("button",{type:"button",class:"btn-close",onClick:j,"aria-label":"Close"})]),t("div",Mt,[t("div",Ut,[e[16]||(e[16]=t("label",{class:"form-label"},"Comprador",-1)),E(t("select",{"onUpdate:modelValue":e[2]||(e[2]=o=>l.buyer_id=o),class:q(["form-select",{"is-invalid":u.buyer_id}]),disabled:h.value,required:""},[e[15]||(e[15]=t("option",{value:""},"Seleccione un comprador",-1)),(a(!0),i(k,null,C(Y.value,o=>(a(),i("option",{key:o.id,value:o.id},n(o.name)+" ("+n(o.company||"Sin empresa")+") - "+n(o.type==="mayorista"?"Mayorista":"Minorista"),9,Rt))),128))],10,Lt),[[W,l.buyer_id]]),t("div",zt,n(u.buyer_id),1)]),t("div",Qt,[e[17]||(e[17]=t("label",{class:"form-label"},"Fecha",-1)),E(t("input",{"onUpdate:modelValue":e[3]||(e[3]=o=>l.date=o),type:"date",class:q(["form-control",{"is-invalid":u.date}]),readonly:h.value,required:""},null,10,Jt),[[A,l.date]]),t("div",Wt,n(u.date),1)])]),t("div",Yt,[e[21]||(e[21]=t("label",{class:"form-label"},"Productos",-1)),(a(!0),i(k,null,C(l.items,(o,r)=>(a(),i("div",{key:r,class:"d-flex align-items-center mb-2"},[E(t("select",{"onUpdate:modelValue":b=>o.cod=b,class:q(["form-select me-2",{"is-invalid":u[`items-${r}-cod`]}]),disabled:h.value,required:"",onChange:b=>st(r)},[e[18]||(e[18]=t("option",{value:""},"Seleccione producto",-1)),(a(!0),i(k,null,C(H.value,b=>(a(),i("option",{key:b.cod,value:b.cod,disabled:b.stock<=0},n(b.name)+" ("+n(b.cod)+") - Stock: "+n(b.stock)+" - Precio: "+n(_(b.unit_cost)),9,Gt))),128))],42,Ht),[[W,o.cod]]),E(t("input",{"onUpdate:modelValue":b=>o.qty=b,type:"number",min:"1",max:ot(o.cod),class:q(["form-control me-2",{"is-invalid":u[`items-${r}-qty`]}]),style:{width:"100px"},readonly:h.value,required:""},null,10,Kt),[[A,o.qty,void 0,{number:!0}]]),t("span",Xt,n(_(o.unit_price*o.qty)),1),h.value?y("",!0):(a(),i("button",{key:0,type:"button",class:"btn btn-sm btn-outline-secondary",onClick:b=>et(r)},e[19]||(e[19]=[t("i",{class:"fa-solid fa-trash"},null,-1)]),8,Zt)),t("div",te,n(u[`items-${r}-cod`]||u[`items-${r}-qty`]),1)]))),128)),h.value?y("",!0):(a(),i("button",{key:0,type:"button",class:"btn btn-sm btn-outline-secondary",onClick:U},e[20]||(e[20]=[t("i",{class:"fa-solid fa-plus me-1"},null,-1),f(" Agregar Producto ")]))),u.items?(a(),i("div",ee,n(u.items),1)):y("",!0)]),t("div",se,[t("div",oe,[e[22]||(e[22]=t("strong",null,"Total:",-1)),t("span",null,n(_(O.value)),1)])]),t("div",ne,[t("button",{type:"button",class:"btn btn-secondary me-2",onClick:j,disabled:S.value}," Cancelar ",8,le),h.value?y("",!0):(a(),i("button",{key:0,type:"submit",class:"btn btn-outline-primary",disabled:S.value||l.items.length===0},[S.value?(a(),i("span",ie)):y("",!0),f(" "+n(l.id?"Actualizar":"Registrar")+" Venta ",1)],8,ae))])],32)],512),t("dialog",{ref_key:"confirmDialog",ref:F,class:"p-3 border-0"},[e[24]||(e[24]=t("h5",{class:"mb-3"},[t("i",{class:"fa-solid fa-triangle-exclamation text-warning me-2"}),f("Confirmar cancelación")],-1)),t("p",null,"¿Está seguro de cancelar la venta #"+n((c=D.value)==null?void 0:c.id)+"?",1),t("div",re,[t("button",{type:"button",class:"btn btn-secondary me-2",onClick:z,disabled:x.value}," Cancelar ",8,de),t("button",{type:"button",class:"btn btn-outline-secondary",onClick:rt,disabled:x.value},[x.value?(a(),i("span",ue)):y("",!0),e[23]||(e[23]=f(" Confirmar Cancelación "))],8,ce)])],512),t("dialog",{ref_key:"invoiceDialog",ref:N,class:"p-0 border-0",style:{"max-width":"800px",width:"100%",padding:"0"}},[t("div",me,[t("div",{class:"d-flex justify-content-between align-items-center mb-3"},[e[25]||(e[25]=t("h5",null,"Factura Legal",-1)),t("button",{type:"button",class:"btn-close",onClick:ut,"aria-label":"Close"})]),d.value?(a(),i("div",be,[t("div",fe,[t("div",pe,[t("h2",ve,n(d.value.companyInfo.name),1),t("p",ye,n(d.value.companyInfo.address),1),t("p",ge,"Tel: "+n(d.value.companyInfo.phone),1),t("p",_e,"NIT: "+n(d.value.companyInfo.nit),1)]),t("div",he,[e[29]||(e[29]=t("h3",{class:"text-primary"},"FACTURA",-1)),t("p",we,[e[26]||(e[26]=t("strong",null,"N°:",-1)),f(" "+n(d.value.invoiceNumber),1)]),t("p",ke,[e[27]||(e[27]=t("strong",null,"Fecha:",-1)),f(" "+n(d.value.fechaEmision),1)]),t("p",Ce,[e[28]||(e[28]=t("strong",null,"Autorización:",-1)),f(" "+n(d.value.companyInfo.numeroAutorizacion),1)])])]),t("div",Se,[t("div",xe,[t("h6",De,[e[30]||(e[30]=t("strong",null,"Señor(es):",-1)),f(" "+n(d.value.buyer.name),1)]),t("p",Ie,[e[31]||(e[31]=t("strong",null,"NIT/CI:",-1)),f(" "+n(d.value.buyer.tax_id),1)])]),t("div",Ee,[t("p",qe,[e[32]||(e[32]=t("strong",null,"Actividad Económica:",-1)),f(" "+n(d.value.companyInfo.actividadEconomica),1)])])]),t("table",Pe,[e[34]||(e[34]=t("thead",null,[t("tr",null,[t("th",{width:"60"},"Cant."),t("th",null,"Descripción"),t("th",{width:"100"},"P. Unit."),t("th",{width:"120"},"Subtotal")])],-1)),t("tbody",null,[(a(!0),i(k,null,C(d.value.items,(o,r)=>(a(),i("tr",{key:r},[t("td",null,n(o.qty),1),t("td",null,n(R(o.cod)),1),t("td",$e,n(_(o.unit_price)),1),t("td",Te,n(_(o.unit_price*o.qty)),1)]))),128))]),t("tfoot",null,[t("tr",null,[e[33]||(e[33]=t("td",{colspan:"3",class:"text-end"},[t("strong",null,"TOTAL Bs.")],-1)),t("td",Ve,[t("strong",null,n(_(d.value.total)),1)])])])]),t("div",Fe,[t("div",Ne,[t("p",Be,n(d.value.companyInfo.leyenda),1),t("p",je,[e[35]||(e[35]=t("strong",null,"Fecha Límite Emisión:",-1)),f(" "+n(d.value.companyInfo.fechaLimiteEmision),1)])]),t("div",Ae,[t("img",{src:d.value.codigoQR,alt:"Código QR",class:"img-fluid",style:{"max-width":"120px"}},null,8,Oe),t("p",Me,"Código de Control: "+n(d.value.companyInfo.codigoControl),1)])]),t("div",{class:"d-flex justify-content-between mt-4"},[t("button",{class:"btn btn-outline-secondary",onClick:mt},e[36]||(e[36]=[t("i",{class:"fa-solid fa-print me-1"},null,-1),f(" Imprimir ")])),t("button",{class:"btn btn-primary",onClick:bt},e[37]||(e[37]=[t("i",{class:"fa-solid fa-download me-1"},null,-1),f(" Descargar PDF ")]))])])):y("",!0)])],512)])}}},We=pt(Ue,[["__scopeId","data-v-a284eab8"]]);export{We as default};
