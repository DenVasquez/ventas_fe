import{_ as Y,r as y,f as L,g as M,h as Z,n as ee,o as r,c as d,b as e,k as b,l as p,d as g,v as h,t as i,F as B,i as N,w as te,m as _,e as w,j as oe}from"./index-0c1afda6.js";import{u as se}from"./productos.store-faf1803a.js";import{u as le}from"./material.store-3b57c0b7.js";import{T as ne}from"./bootstrap.esm-5571e70d.js";import"./sale.store-8ef729cf.js";const ae={class:"container py-4"},ie={class:"d-flex justify-content-between align-items-center mb-3"},re=["disabled"],de={class:"mb-3"},ce=["disabled"],ue={key:0,class:"text-center my-4"},me={key:1,class:"alert alert-danger"},be={key:2,class:"alert alert-info"},fe={key:3,class:"table-responsive"},ve={class:"table table-bordered table-hover mb-0"},pe={class:"d-flex align-items-center"},ye=["onClick","disabled"],ge=["onClick","disabled"],_e=["onClick","disabled"],ke=["data-bs-title"],he={class:"text-end"},we={class:"d-flex justify-content-between align-items-center"},Ce={class:"row g-2 mb-2"},Se={class:"col-md-6"},qe=["readonly"],xe={class:"invalid-feedback"},$e={class:"col-md-6"},Pe=["readonly"],Ve={class:"invalid-feedback"},Ee={class:"row g-2 mb-2"},De={class:"col-md-6"},Me=["readonly"],Be={class:"invalid-feedback"},Ne={class:"col-md-6"},Oe=["readonly"],Te={class:"invalid-feedback"},je={class:"mb-3"},Ue=["onUpdate:modelValue","disabled"],Ie=["value","disabled"],Fe=["onUpdate:modelValue","readonly"],Le=["onClick"],Ae={class:"invalid-feedback"},Re={class:"d-flex justify-content-end mt-3"},ze=["disabled"],Je=["disabled"],Ge={key:0,class:"spinner-border spinner-border-sm me-1",role:"status","aria-hidden":"true"},He={class:"d-flex justify-content-end mt-3"},Ke=["disabled"],Qe=["disabled"],We={key:0,class:"spinner-border spinner-border-sm me-1",role:"status","aria-hidden":"true"},A=10,Xe={__name:"InventoryView",props:{isAdmin:{type:Boolean,default:!1}},setup(Ye){const a=se(),q=le(),$=y(""),P=y(null),V=y(null),x=y("new"),C=y(!1),S=y(!1),k=y(null),s=L({id:null,cod:"",name:"",unit_cost:0,stock:0,bom:[]}),n=L({}),R=M(()=>{const o=$.value.toLowerCase();return a.productos.filter(t=>t.name.toLowerCase().includes(o)||t.cod.toLowerCase().includes(o)).sort((t,c)=>t.name.localeCompare(c.name))}),z=M(()=>{switch(x.value){case"new":return"Nuevo Producto";case"edit":return"Editar Producto";case"view":return"Ver Producto";default:return"Producto"}}),f=M(()=>x.value==="view");function J(o){return new Intl.NumberFormat("es-BO",{style:"currency",currency:"BOB"}).format(o)}function G(o){return(o==null?void 0:o.map(t=>{const c=q.materiales.find(u=>u.cod===t.cod);return`${(c==null?void 0:c.name)||t.cod} (${t.qty})`}).join(", "))||"Sin materiales"}function O(o){return o.stock<A}function T(){Object.keys(n).forEach(o=>delete n[o])}function H(){T();let o=!0;return s.cod.trim()||(n.cod="El código es requerido",o=!1),s.name.trim()||(n.name="El nombre es requerido",o=!1),s.unit_cost<=0&&(n.unit_cost="El costo debe ser mayor a 0",o=!1),s.stock<0&&(n.stock="El stock no puede ser negativo",o=!1),s.bom.forEach((t,c)=>{if(t.cod||(n[`bom-${c}-cod`]="Seleccione un material",o=!1),!t.qty||t.qty<=0)n[`bom-${c}-qty`]="Cantidad inválida",o=!1;else{const u=q.materiales.find(l=>l.cod===t.cod);u&&u.stock<t.qty*s.stock&&(n[`bom-${c}-qty`]=`Stock insuficiente (${u.stock} disponibles)`,o=!1)}}),s.bom.length===0&&(n.bom="Debe agregar al menos un material",o=!1),o}function E(o,t=null){if(x.value=o,t)Object.assign(s,JSON.parse(JSON.stringify(t)));else if(j(),U(),a.productos.length>0){const u=a.productos[a.productos.length-1].cod.match(/(\d+)$/);if(u){const l=parseInt(u[1])+1;s.cod=`PROD-${l.toString().padStart(3,"0")}`}}else s.cod="PROD-001";P.value.showModal()}function D(){P.value.close(),j()}function j(){s.id=null,s.cod="",s.name="",s.unit_cost=0,s.stock=0,s.bom=[],T()}function U(){s.bom.push({cod:"",qty:1})}function K(o){s.bom.splice(o,1)}async function Q(){if(H()){C.value=!0;try{x.value==="new"?await a.addProducto({...s}):await a.updateProducto(s.id,{...s}),D()}catch(o){console.error("Error al guardar producto:",o),o.response&&o.response.data?alert(`Error: ${o.response.data.message}`):alert("Ocurrió un error al guardar el producto")}finally{C.value=!1}}}function W(o){k.value=o,V.value.showModal()}function I(){V.value.close(),k.value=null}async function X(){if(k.value){S.value=!0;try{await a.deleteProducto(k.value.id),I()}catch(o){console.error("Error al eliminar producto:",o),alert("Ocurrió un error al eliminar el producto")}finally{S.value=!1}}}async function F(){try{await Promise.all([a.fetchProductos(),q.fetchMateriales()])}catch(o){console.error("Error al cargar datos:",o)}}return Z(async()=>{await F(),ee(()=>{document.querySelectorAll('[data-bs-toggle="tooltip"]').forEach(o=>{new ne(o)})})}),(o,t)=>{var c,u;return r(),d("div",ae,[e("div",ie,[t[7]||(t[7]=e("h2",null,"Productos Terminados",-1)),e("button",{class:"btn btn-success",onClick:t[0]||(t[0]=l=>E("new")),disabled:b(a).loading},t[6]||(t[6]=[e("i",{class:"fa-solid fa-plus"},null,-1),p(" Nuevo Producto ")]),8,re)]),e("div",de,[g(e("input",{"onUpdate:modelValue":t[1]||(t[1]=l=>$.value=l),type:"text",class:"form-control",placeholder:"Filtrar por nombre o código...",disabled:b(a).loading},null,8,ce),[[h,$.value]])]),b(a).loading&&!b(a).productos.length?(r(),d("div",ue,t[8]||(t[8]=[e("div",{class:"spinner-border text-primary",role:"status"},[e("span",{class:"visually-hidden"},"Cargando...")],-1),e("p",{class:"mt-2"},"Cargando productos...",-1)]))):b(a).error?(r(),d("div",me,[t[9]||(t[9]=e("i",{class:"fa-solid fa-triangle-exclamation me-2"},null,-1)),p(" Error al cargar productos: "+i(b(a).error)+" ",1),e("button",{class:"btn btn-sm btn-outline-danger ms-2",onClick:F}," Reintentar ")])):b(a).productos.length?(r(),d("div",fe,[e("table",ve,[t[15]||(t[15]=e("thead",{class:"table-light"},[e("tr",null,[e("th",{width:"120"},"Acciones"),e("th",{width:"100"},"Código"),e("th",null,"Nombre"),e("th",{width:"120"},"Costo"),e("th",{width:"120"},"Stock"),e("th",null,"Materiales")])],-1)),e("tbody",null,[(r(!0),d(B,null,N(R.value,l=>(r(),d("tr",{key:l.id},[e("td",null,[e("div",pe,[e("button",{class:"btn btn-sm btn-outline-primary me-1",onClick:v=>E("view",l),disabled:b(a).loading},t[11]||(t[11]=[e("i",{class:"fa-solid fa-eye"},null,-1)]),8,ye),e("button",{class:"btn btn-sm btn-outline-success me-1",onClick:v=>E("edit",l),disabled:b(a).loading},t[12]||(t[12]=[e("i",{class:"fa-solid fa-pen-to-square"},null,-1)]),8,ge),e("button",{class:"btn btn-sm btn-outline-secondary me-2",onClick:v=>W(l),disabled:b(a).loading},t[13]||(t[13]=[e("i",{class:"fa-solid fa-trash"},null,-1)]),8,_e),O(l)?(r(),d("span",{key:0,class:"blinking-icon","data-bs-toggle":"tooltip","data-bs-placement":"top","data-bs-title":`Stock bajo! Mínimo requerido: ${A}`},t[14]||(t[14]=[e("i",{class:"fa-solid fa-triangle-exclamation text-danger fa-lg"},null,-1)]),8,ke)):w("",!0)])]),e("td",null,i(l.cod),1),e("td",null,i(l.name),1),e("td",he,i(J(l.unit_cost)),1),e("td",{class:_(["text-end",{"text-danger":O(l)}])},i(l.stock),3),e("td",null,i(G(l.bom)),1)]))),128))])])])):(r(),d("div",be,t[10]||(t[10]=[e("i",{class:"fa-solid fa-circle-info me-2"},null,-1),p(" No se encontraron productos registrados. ")]))),e("dialog",{ref_key:"productDialog",ref:P,class:"p-0 border-0"},[e("form",{onSubmit:te(Q,["prevent"]),class:"p-3"},[e("h5",we,[e("span",null,i(z.value),1),e("button",{type:"button",class:"btn-close",onClick:D,"aria-label":"Close"})]),e("div",Ce,[e("div",Se,[t[16]||(t[16]=e("label",{class:"form-label"},"Código",-1)),g(e("input",{"onUpdate:modelValue":t[2]||(t[2]=l=>s.cod=l),type:"text",class:_(["form-control",{"is-invalid":n.cod}]),readonly:f.value,required:""},null,10,qe),[[h,s.cod]]),e("div",xe,i(n.cod),1)]),e("div",$e,[t[17]||(t[17]=e("label",{class:"form-label"},"Nombre",-1)),g(e("input",{"onUpdate:modelValue":t[3]||(t[3]=l=>s.name=l),type:"text",class:_(["form-control",{"is-invalid":n.name}]),readonly:f.value,required:""},null,10,Pe),[[h,s.name]]),e("div",Ve,i(n.name),1)])]),e("div",Ee,[e("div",De,[t[18]||(t[18]=e("label",{class:"form-label"},"Costo unitario (Bs)",-1)),g(e("input",{"onUpdate:modelValue":t[4]||(t[4]=l=>s.unit_cost=l),type:"number",step:"0.01",min:"0",class:_(["form-control",{"is-invalid":n.unit_cost}]),readonly:f.value,required:""},null,10,Me),[[h,s.unit_cost,void 0,{number:!0}]]),e("div",Be,i(n.unit_cost),1)]),e("div",Ne,[t[19]||(t[19]=e("label",{class:"form-label"},"Stock",-1)),g(e("input",{"onUpdate:modelValue":t[5]||(t[5]=l=>s.stock=l),type:"number",step:"1",min:"0",class:_(["form-control",{"is-invalid":n.stock}]),readonly:f.value,required:""},null,10,Oe),[[h,s.stock,void 0,{number:!0}]]),e("div",Te,i(n.stock),1)])]),e("div",je,[t[23]||(t[23]=e("label",{class:"form-label"},"Lista de Materiales (BOM)",-1)),(r(!0),d(B,null,N(s.bom,(l,v)=>(r(),d("div",{key:v,class:"d-flex align-items-center mb-2"},[g(e("select",{"onUpdate:modelValue":m=>l.cod=m,class:_(["form-select me-2",{"is-invalid":n[`bom-${v}-cod`]}]),disabled:f.value,required:""},[t[20]||(t[20]=e("option",{value:""},"Seleccionar material",-1)),(r(!0),d(B,null,N(b(q).materiales,m=>(r(),d("option",{key:m.cod,value:m.cod,disabled:m.stock<=0},i(m.name)+" ("+i(m.cod)+") - Stock: "+i(m.stock),9,Ie))),128))],10,Ue),[[oe,l.cod]]),g(e("input",{"onUpdate:modelValue":m=>l.qty=m,type:"number",min:"1",step:"1",class:_(["form-control me-2",{"is-invalid":n[`bom-${v}-qty`]}]),style:{width:"100px"},readonly:f.value,required:""},null,10,Fe),[[h,l.qty,void 0,{number:!0}]]),f.value?w("",!0):(r(),d("button",{key:0,type:"button",class:"btn btn-sm btn-outline-secondary",onClick:m=>K(v)},t[21]||(t[21]=[e("i",{class:"fa-solid fa-trash"},null,-1)]),8,Le)),e("div",Ae,i(n[`bom-${v}-cod`]||n[`bom-${v}-qty`]),1)]))),128)),f.value?w("",!0):(r(),d("button",{key:0,type:"button",class:"btn btn-sm btn-outline-secondary",onClick:U},t[22]||(t[22]=[e("i",{class:"fa-solid fa-plus me-2"},null,-1),p("Agregar Material ")])))]),e("div",Re,[e("button",{type:"button",class:"btn btn-secondary me-2",onClick:D,disabled:C.value}," Cancelar ",8,ze),f.value?w("",!0):(r(),d("button",{key:0,type:"submit",class:"btn btn-outline-primary",disabled:C.value},[C.value?(r(),d("span",Ge)):w("",!0),p(" "+i(s.id?"Actualizar":"Guardar"),1)],8,Je))])],32)],512),e("dialog",{ref_key:"confirmDialog",ref:V,class:"p-3 border-0"},[t[26]||(t[26]=e("h5",{class:"mb-3"},[e("i",{class:"fa-solid fa-triangle-exclamation text-warning me-2"}),p("Confirmar eliminación")],-1)),e("p",null,[t[24]||(t[24]=p("¿Está seguro de eliminar el producto ")),e("strong",null,i((c=k.value)==null?void 0:c.name),1),p(" ("+i((u=k.value)==null?void 0:u.cod)+")?",1)]),e("div",He,[e("button",{type:"button",class:"btn btn-secondary me-2",onClick:I,disabled:S.value}," Cancelar ",8,Ke),e("button",{type:"button",class:"btn btn-outline-secondary",onClick:X,disabled:S.value},[S.value?(r(),d("span",We)):w("",!0),t[25]||(t[25]=p(" Eliminar "))],8,Qe)])],512)])}}},lt=Y(Xe,[["__scopeId","data-v-0a29c613"]]);export{lt as default};
